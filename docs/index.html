<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ark – Security Camera FOV</title>
  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; margin:0; background:#111; color:#eee; }
    #wrap { height:100%; display:grid; }
    #mp { width:100%; height:100%; border:0; display:block; }
    .badge {
      position:absolute; left:10px; top:10px; z-index:5;
      padding:6px 10px; font:12px system-ui;
      background:rgba(0,0,0,.55); border:1px solid #333; border-radius:8px;
    }
  </style>
</head>
<body>
  <div class="badge" id="badge">loading…</div>

  <!-- Your space (IFRAME viewer) -->
  <div id="wrap">
    <iframe
      id="mp"
      allow="xr-spatial-tracking; fullscreen"
      allowfullscreen
      src="https://my.matterport.com/show/?m=1ghABoaBFPZ&play=1&qs=1&title=0&brand=0">
    </iframe>
  </div>

  <!-- 1) Load the Matterport IFRAME SDK -->
  <script src="https://static.matterport.com/showcase-sdk/latest.js"></script>

  <!-- 2) Your page code -->
  <script>
  (function () {
    const SDK_KEY = "akqd0dp3hr9wz4eu70zd1rsab";
    const iframe  = document.getElementById("mp");
    const badge   = document.getElementById("badge");

    function fail(msg) {
      console.error(msg);
      badge.textContent = msg;
    }

    // Wait until the MP SDK script defines window.MP_SDK
    function waitForSdk(maxMs = 8000) {
      return new Promise((resolve, reject) => {
        const t0 = performance.now();
        (function poll() {
          if (window.MP_SDK && typeof window.MP_SDK.connect === "function") return resolve();
          if (performance.now() - t0 > maxMs) return reject(new Error("IFRAME SDK failed to load"));
          requestAnimationFrame(poll);
        })();
      });
    }

    async function main() {
      try {
        await waitForSdk();
      } catch (e) {
        return fail("[Ark] The SDK script didn't load. Check ad/content blockers and allowlist static.matterport.com");
      }

      let sdk;
      try {
        sdk = await window.MP_SDK.connect(iframe, SDK_KEY /*, '3.3' optional */);
        badge.textContent = "SDK connected";
      } catch (e) {
        return fail("[Ark] MP_SDK.connect() failed: " + e);
      }

      // Load our plugin (runs INSIDE Showcase)
      try {
        const url = "/Ark/plugins/security-cam.js?v=1";
        if (sdk.App.loadPlugin) {
          await sdk.App.loadPlugin(url);
        } else if (sdk.App.showPlugin) {
          await sdk.App.showPlugin(url);
        } else {
          console.warn("No loadPlugin/showPlugin on this build; attempting fallback");
          // Fallback: some very old builds call our global hook automatically.
        }
        console.log("[ark] plugin loaded");
      } catch (e) {
        console.error(e);
        return fail("[Ark] Failed to load plugin (see console)");
      }

      // Helper to add a camera at the current viewer pose
      async function addCamAtViewer(hfov = 90) {
        const pose = await sdk.Camera.getPose();
        const node = await sdk.Scene.createNode();
        node.addComponent("ark.securityCam", {
          worldPosition: pose.position,
          worldRotationQuat: pose.rotation,
          hfovDeg: hfov,
          aspect: 16/9,
          near: 0.3,
          far: 12,
          color: 0x00aaff,
          opacity: 0.18,
          wireOpacity: 0.6,
          panEnabled: false
        });
        await node.start();
        console.log("[ark] security cam added at viewer pose");
        return node;
      }

      // Add one immediately
      await addCamAtViewer(90);

      // Expose helper for console use
      window.addCamAtViewer = addCamAtViewer;

      // Quick sanity ping
      console.log("pose", await sdk.Camera.getPose());
      badge.textContent = "SDK + plugin ready";
    }

    main();
  })();
  </script>
</body>
</html>