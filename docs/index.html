<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ark – Security Camera FOV (IFRAME SDK)</title>
  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; margin:0; background:#111; color:#eee; }
    #wrap { height:100%; display:grid; }
    #mp   { width:100%; height:100%; border:0; display:block; }
    .badge {
      position:absolute; left:10px; top:10px; z-index:5;
      padding:6px 10px; font:12px system-ui;
      background:rgba(0,0,0,.55); border:1px solid #333; border-radius:8px;
    }
  </style>
</head>
<body>
  <div class="badge" id="badge">loading…</div>

  <!-- Your space (IFRAME viewer) -->
  <div id="wrap">
    <iframe
      id="mp"
      allow="xr-spatial-tracking; fullscreen"
      allowfullscreen
      src="https://my.matterport.com/show/?m=1ghABoaBFPZ&play=1&qs=1&title=0&brand=0">
    </iframe>
  </div>

  <!-- Load the Matterport IFRAME SDK (served from static.matterport.com) -->
  <script src="https://static.matterport.com/showcase-sdk/latest.js"></script>

  <!-- Your code -->
  <script>
(async function () {
  const SDK_KEY = "akqd0dp3hr9wz4eu70zd1rsab";
  const iframe  = document.getElementById("mp");
  const badge   = document.getElementById("badge");

  function fail(msg){ console.error(msg); badge.textContent = msg; }

  // Wait until MP_SDK is present (handles content blockers)
  await new Promise((res, rej) => {
    const t0 = performance.now();
    (function spin(){
      if (window.MP_SDK && typeof MP_SDK.connect === "function") return res();
      if (performance.now()-t0 > 8000) return rej(new Error("IFRAME SDK failed to load"));
      setTimeout(spin, 50);
    })();
  }).catch(e => fail(e.message));

  let sdk;
  try {
    sdk = await MP_SDK.connect(iframe, SDK_KEY, "3.2");
  } catch (e) {
    return fail(`connect() failed: ${e.message}`);
  }

  const info = await sdk.Model.getData();
  badge.textContent = `SDK connected — model: ${info.sid}`;

  // Absolute plugin URL within your repo
  const base = location.origin + location.pathname.replace(/\/[^/]*$/, "");
  const PLUGIN_URL = `${base}/plugins/security-cam.js`;

  // Load the plugin into Showcase
  try {
    await sdk.App.addPlugin(PLUGIN_URL);
    console.log("plugin loaded", PLUGIN_URL);
  } catch (e) {
    return fail(`addPlugin failed: ${e.message}`);
  }

  // Poll until the component is usable, then add one at the current pose
  async function waitFor(type, timeoutMs = 8000) {
    const t0 = performance.now();
    while (performance.now() - t0 < timeoutMs) {
      try {
        const node = await sdk.Scene.createNode();
        node.addComponent(type);
        await sdk.Scene.deleteNode(node.id);
        return;
      } catch { await new Promise(r => setTimeout(r, 100)); }
    }
    throw new Error(`${type} did not register in time`);
  }

  await waitFor("ark.securityCam");

  async function addCamAtViewer(hfov = 90) {
    const pose = await sdk.Camera.getPose();
    const node = await sdk.Scene.createNode();
    const comp = node.addComponent("ark.securityCam");
    const inputs = {
      worldPosition: pose.position,
      worldRotationQuat: pose.rotation,
      hfovDeg: hfov, aspect: 16/9, near: 0.3, far: 12,
      color: 0x00aaff, opacity: 0.18, wireOpacity: 0.6, panEnabled: false
    };
    if (comp.inputs?.set) comp.inputs.set(inputs); else Object.assign(comp.inputs, inputs);
    await node.start();
    console.log("security cam added", node.id);
    return node.id;
  }

  await addCamAtViewer(90);
  window.addCamAtViewer = addCamAtViewer;
})();
</script>
</body>
</html>