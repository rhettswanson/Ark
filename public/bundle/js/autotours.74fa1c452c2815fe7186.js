/*! For license information please see autotours.74fa1c452c2815fe7186.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[587],{248:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"ImportAutoGallery"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"importAutoGallery"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[]}]}}],loc:{start:0,end:85}};t.loc.source={body:"mutation ImportAutoGallery($modelId: ID!) {\n  importAutoGallery(modelId: $modelId)\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function a(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){a(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){a(e,t)})),e.definitions&&e.definitions.forEach((function(e){a(e,t)}))}var n={};function i(e,t){for(var a=0;a<e.definitions.length;a++){var n=e.definitions[a];if(n.name&&n.name.value==t)return n}}t.definitions.forEach((function(e){if(e.name){var t=new Set;a(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.ImportAutoGallery=function(e,t){var a={kind:e.kind,definitions:[i(e,t)]};e.hasOwnProperty("loc")&&(a.loc=e.loc);var o=n[t]||new Set,s=new Set,r=new Set;for(o.forEach((function(e){r.add(e)}));r.size>0;){var l=r;r=new Set,l.forEach((function(e){s.has(e)||(s.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return s.forEach((function(t){var n=i(e,t);n&&a.definitions.push(n)})),a}(t,"ImportAutoGallery")},47067:(e,t,a)=>{"use strict";a.d(t,{P:()=>o});var n=a(12554),i=a(85616);class o extends i.v{constructor(e){super(),this.reel=(0,n.Z)([]),this.modified=new Date,this.mode=e,this.commit()}replace(e){this.atomic((()=>{this.sid=e.sid,this.reel.replace(Array.from(e.reel.values())),this.mode=e.mode,this.modified=e.modified}))}}},37e3:(e,t,a)=>{"use strict";a.d(t,{Wu:()=>f});var n=a(10843),i=a(13893),o=a(1333),s=a(25481),r=a(44094),l=a(74381),d=a(72853),u=a(57186),c=a(93877);const h=new n.Ay("mds-reel-element-serializer"),p={[l.ES.FADE_TO_BLACK]:i.fl.FadeToBlack,[l.ES.INSTANT]:i.fl.Instant,[l.ES.INTERPOLATE]:i.fl.Interpolate},m={[l.Zw.LEFT]:o.ND.Left,[l.Zw.RIGHT]:o.ND.Right,[l.Zw.AUTO]:o.ND.Auto};class f{constructor(e){this.sweepTagRequirements=e,this.assetDeserializer=new d.S,this.viewDeserailizer=new u.K}deserialize(e){var t;if(!e||!(null===(t=null==e?void 0:e.asset)||void 0===t?void 0:t.id))return h.debug("Deserialized invalid highlight reel entry from MDS",e),null;const a=e.overrides,n={},i=(null==a?void 0:a.transitionType)?p[null==a?void 0:a.transitionType]:void 0,o=(null==a?void 0:a.panDirection)?m[null==a?void 0:a.panDirection]:void 0,l=null==a?void 0:a.panAngle;(0,r.s)(i)&&(n.transitionType=i),(0,r.s)(o)&&(n.panDirection=o),(0,s.Et)(l)&&(n.panAngle=l);const d=this.assetDeserializer.deserialize(e.asset),u=null==d?void 0:d.metadata.scanTags,f=!this.sweepTagRequirements||!u||u.includes(this.sweepTagRequirements);if(!d||!f)return null;let g;const v=this.viewDeserailizer.getModelViewType(e.sourceView);v!==c.jK.DEFURNISH&&v!==c.jK.DIGIPRO_SESSION||(g=e.sourceView.id),d.sourceViewId=g,v===c.jK.INSIGHTS&&(d.sourceViewId=e.sourceView.id,n.panAlignment="center");const w={id:e.asset.id,overrides:n,snapshot:d,sourceViewId:g};return e.title&&(w.title=e.title),e.description&&(w.description=e.description),w}}},80696:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>C});var n=a(65945),i=a(75578),o=a(27947),s=a(22585),r=a(90082),l=a(71687),d=a(28165),u=a(2993),c=a(10843),h=a(73566),p=a(64650),m=a(73094),f=a(95300),g=a(25712),v=a(74381),w=a(13893),D=a(47067),y=a(35447),I=a(93327),T=a(56388),A=a(24790),S=a(37e3);const b=new c.Ay("get-highlights-for-view"),O=async({client:e,modelId:t,viewType:a})=>{var n,i,o,s,r;const l=[],d=e||(0,T.H)({baseUrl:window.location.origin,server:A.wD})(),u={modelId:t,viewType:a},{data:c}=await d.query(I.GetHighlightReelForView,u),h=new S.Wu(null);return null===(r=null===(s=null===(o=null===(i=null===(n=null==c?void 0:c.model)||void 0===n?void 0:n.view)||void 0===i?void 0:i.model)||void 0===o?void 0:o.activeHighlightReel)||void 0===s?void 0:s.reel)||void 0===r||r.forEach((e=>{const t=h.deserialize(e);t?l.push(t):b.warn("Failed to deserialize reel")})),l};var E=a(248);const R=async({client:e,modelId:t})=>{const a=e||(0,T.H)({baseUrl:window.location.origin,server:A.wD})(),n={modelId:t},{data:i}=await a.query(E.ImportAutoGallery,n);return!!(null==i?void 0:i.importAutoGallery)};var M=a(941);const j=[M.mg,M.GC];class P{constructor({roomBoundData:e,sweepData:t,cameraStartModule:a,snapshotsModule:n,floorsData:i,layersData:o}){this.floorsData=i,this.sweepData=t,this.roomBoundData=e,this.cameraStartModule=a,this.snapshotsModule=n,this.layersData=o}async generateTour(e){var t;const{modelId:a,panAngle:n,panDuration:i}=e;await R({modelId:a});const o=await O({modelId:a,viewType:"matterport.user.insights"})||[],s={snapshot:{sourceViewId:null===(t=this.layersData.getInsightsView())||void 0===t?void 0:t.id},resizeAspect:f.BE},r=(e=>{const{cameraStartModule:t,snapshotsModule:a}=e;return(e={})=>{const n=t.data.icon;if(!n)return;let i=a.snapshotsData.get(n);if(e.snapshot&&(i=i.copy(Object.assign(Object.assign({},i),e.snapshot))),e.resizeAspect){const t=(0,f.IX)(i.width,i.height,e.resizeAspect);i.width=t.width,i.height=t.height}return{id:i.sid,snapshot:i}}})({cameraStartModule:this.cameraStartModule,snapshotsModule:this.snapshotsModule})(s);r&&o.unshift(r),o.forEach((e=>{if(e.overrides={transitionType:w.fl.Interpolate,panAlignment:"center",panAngle:n,panDuration:i},!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}}));const l=new D.P(v.UR.STORY),d=(e=>{const{sweepData:t,roomBoundData:a}=e;return e=>e.reduce(((e,n)=>{var i;const{cameraPosition:o,scanId:s}=n.snapshot.metadata;if(!o||!s)return e;const r=null===(i=t.getSweep(s))||void 0===i?void 0:i.floorId;if(!r)return e;const l=a.findRoomIdForPosition(o,r)||null;return e.push(Object.assign(Object.assign({},n),{floorId:r,roomId:l,sweepId:s})),e}),[])})({sweepData:this.sweepData,roomBoundData:this.roomBoundData})(o),u=this.postfilter(this.sort(this.prefilter(d))),c=u.find((e=>e.id===(null==r?void 0:r.id)));return u.length>2&&c&&u.push(Object.assign(Object.assign({},c),{id:(0,g.hA)()})),l.reel.replace(u),l}prefilter(e){if(!(null==e?void 0:e.length))return e;return e.filter((e=>{var t;if((0,y.Qx)(e))return!0;const{cameraPosition:a}=e.snapshot.metadata,n=e.roomId;if(!a||!n)return!1;const i=this.sweepData.getSweep(e.sweepId);if(!i.isAligned()||!i.enabled)return!1;const o=this.roomBoundData.getRoom(n);return!j.includes(null===(t=o.classifications[0])||void 0===t?void 0:t.id)}))}postfilter(e){if(!(null==e?void 0:e.length))return e;const t=new Set,a={};let n=null;return e.filter((e=>{var i;if((0,y.Qx)(e))return!0;const{cameraPosition:o}=e.snapshot.metadata,{roomId:s,sweepId:r}=e;if(!o||!s)return!1;if(t.has(r))return!1;const l=this.sweepData.getSweep(r);if(n){if(n.position.distanceTo(l.position)<2)return!1}return!((null===(i=this.roomBoundData.getRoom(s).classifications[0])||void 0===i?void 0:i.id)===M.Cp&&a[s]>=1)&&(!(a[s]>=2)&&(t.add(r),a[s]?a[s]+=1:a[s]=1,n=l,!0))}))}sort(e){if(!(null==e?void 0:e.length))return e;const t=new Set,a=e.reduce(((e,t)=>(e[t.id]=t,e)),{}),n=(e=>{const{sweepData:t}=e;return(e,a)=>{if(!e.snapshot.metadata.scanId||a.length<=1)return a[0];const n=t.getSweep(e.snapshot.metadata.scanId);return a.map((e=>{const a=e.snapshot.metadata.scanId,i=t.getSweep(a);return{highlight:e,distance:n.position.distanceToSquared(i.position)}})).sort(((e,t)=>e.distance-t.distance))[0].highlight}})({sweepData:this.sweepData}),i=e=>{if(!e.floorId)return;const i=Object.values(a).filter((a=>a.floorId===e.floorId&&!t.has(a))),o=this.sweepData.getSweep(e.sweepId).neighbours,s=i.filter((e=>!!e.sweepId&&o.includes(e.sweepId))),r=s.length?s:i;return n(e,r)},o=e=>{const n=Object.values(a).find((a=>a.floorId===e.floorId&&!t.has(a)));if(n)return n;const i=this.floorsData.getFloor(e.floorId),o=(null==i?void 0:i.index)||0,s=this.floorsData.getOrderedValues();for(let e=o;e<s.length;e++){const n=s[e],i=Object.values(a).find((e=>e.floorId===n.id&&!t.has(e)));if(i)return i}return Object.values(a).find((e=>!t.has(e)))},s=e=>{t.add(e);const r=(e=>{if(!(null==e?void 0:e.roomId))return;const i=Object.values(a).filter((a=>a.roomId===e.roomId&&!t.has(a)));return i.length>1?n(e,i):i[0]})(e)||i(e)||o(e);r&&s(r)},r=a[e[0].id];s(r);const l=Array.from(t),d=l.find(y.Qx);return d?[d,...l.filter((e=>e.id!==d.id))]:l}}class _{async generateTour(e){const{modelId:t}=e;await R({modelId:t});const a=await O({modelId:t,viewType:"matterport.user.insights"}),n=new D.P(v.UR.REEL);return n.reel.replace(a),n}}var N=a(89103);class k extends N.QB{constructor(){super()}}class G extends N.QB{constructor(){super()}}var z=function(e,t,a,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,a):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,a,n);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(s=(o<3?i(s):o>3?i(t,a,s):i(t,a))||s);return o>3&&s&&Object.defineProperty(t,a,s),s},V=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},B=function(e,t){return function(a,n){t(a,n,e)}};let C=class extends i.n{constructor({data:e},t,{data:a},{data:n},{policyData:i},{data:o},s,r,{data:l},d,{toolsData:u},h,{layersData:p}){super(),this.name="tours-generator",this.templates=new Map,this.applicationData=e,this.cameraStartModule=t,this.floorsData=a,this.modelData=n,this.roomBoundData=o,this.settingsModule=s,this.snapshotsModule=r,this.sweepData=l,this.toursDataModule=h,this.toolsData=u,this.toolAnnouncementModule=d,this.layersData=p,this.enabled=(0,m.W)(i,s.settingsData),c.Ay.for(this).info("AUTO TOURS ENABLED")}async init(e,t){this.engine=t,this.registerTemplates(),this.registerSettings();const a=this.settingsModule.tryGetProperty(d.pH,!1);if(this.applicationData.application===o.lg.SHOWCASE&&a){const e=this.settingsModule.tryGetProperty(d.Ye,d.lB);await this.generateTourFromTemplate(e,{modelId:this.modelData.model.baseModelId}),this.announceAutoGenTourCreated()}else this.enabled&&this.announceAutoGenTourReady()}async generateTourFromTemplate(e,t){if(!this.enabled)throw new Error("Tour generation is not enabled");const a=this.templates.get(e);if(!a)throw new Error(`Template ${e} not found`);this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_READY,h.zR.CLOSE);try{this.engine.broadcast(new k);const e=await a.generateTour(Object.assign({panAngle:this.settingsModule.tryGetProperty(d.nz,d.C0),panDuration:this.settingsModule.tryGetProperty(d.I5,d.XZ)},t));return e.reel.forEach((e=>{if(!e.snapshot.metadata.scanId&&e.snapshot.metadata.cameraPosition){const t=this.sweepData.getClosestSweep(e.snapshot.metadata.cameraPosition,!0);t&&(e.snapshot.metadata.scanId=t.id)}"dollhouse"===e.snapshot.name&&(e.snapshot.metadata.cameraMode=u.N3.Dollhouse,e.snapshot.metadata.scanId=void 0)})),this.replaceActiveReel(e),e}catch(a){return void c.Ay.for(this).error(`Failed to generate tour from [${e}] template`,{error:a,config:t})}finally{this.engine.broadcast(new G)}}announceAutoGenTourCreated(){const e=this.engine.subscribe(s.Fj,(({application:t})=>{t===o.lg.WORKSHOP&&(this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_CREATED,h.zR.OPEN),e.cancel())})),t=this.toolsData.onPropertyChanged("activeToolName",(()=>{this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_CREATED,h.zR.CLOSE),t.cancel()}))}announceAutoGenTourReady(){this.toolAnnouncementModule.setToolAnnouncementState(h.Q7.HLR_AUTOGEN_TOUR_READY,h.zR.OPEN)}replaceActiveReel(e){this.toursDataModule.setHighlightReel(e)}registerTemplates(){this.templates.size>0||(this.templates.set(p.p.SCOUT,new P({cameraStartModule:this.cameraStartModule,floorsData:this.floorsData,roomBoundData:this.roomBoundData,snapshotsModule:this.snapshotsModule,sweepData:this.sweepData,layersData:this.layersData})),this.templates.set(p.p.VISION,new _))}registerSettings(){const e="Tours";this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.Ye,options:[...this.templates.keys()],initialValue:()=>d.lB}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,setting:d.pH,initialValue:()=>!1}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,range:[1,360],rangePrecision:0,setting:d.nz,initialValue:()=>d.C0}),this.settingsModule.registerMenuEntry({header:e,urlParam:!0,range:[1e3,1e4],rangePrecision:0,setting:d.I5,initialValue:()=>d.XZ})}};C=z([(0,n._q)(),B(0,(0,n.y_)(r.WJ)),B(1,(0,n.y_)(l.di)),B(2,(0,n.y_)(l.HX)),B(3,(0,n.y_)(l.bj)),B(4,(0,n.y_)(l.Uu)),B(5,(0,n.y_)(l.Vu)),B(6,(0,n.y_)(r.ZF)),B(7,(0,n.y_)(l.Pn)),B(8,(0,n.y_)(l.Wh)),B(9,(0,n.y_)(l.uq)),B(10,(0,n.y_)(l.N7)),B(11,(0,n.y_)(l.XQ)),B(12,(0,n.y_)(l.az)),V("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object])],C)}}]);